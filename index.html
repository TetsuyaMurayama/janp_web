<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iOS/Android対応スキャナー</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f8f9fa; text-align: center; }
        #interactive.viewport { position: relative; width: 100%; max-width: 400px; height: 300px; margin: 0 auto; overflow: hidden; border: 2px solid #333; border-radius: 8px; }
        #interactive.viewport canvas, video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .drawingBuffer { display: none; } /* デバッグ用の線を表示しない場合は非表示 */
        #result-box { margin-top: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .code { font-size: 1.8rem; font-weight: bold; color: #28a745; margin: 10px 0; }
        button { padding: 12px 24px; font-size: 1rem; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>店舗スタッフ用スキャナー</h2>
    
    <div id="interactive" class="viewport"></div>

    <div id="result-box">
        <div>JANコード読み取り結果:</div>
        <div id="code-value" class="code">---</div>
        <button id="start-btn">スキャン開始</button>
    </div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const codeValue = document.getElementById('code-value');

        startBtn.addEventListener('click', () => {
            startScanner();
            startBtn.disabled = true;
            startBtn.innerText = "スキャン中...";
        });

        function startScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        facingMode: "environment", // 背面カメラを使用
                        aspectRatio: { min: 1, max: 2 }
                    },
                },
                decoder: {
                    readers: ["ean_reader"] // JANコード(EAN-13)に限定
                },
                locate: true // バーコードの位置を自動検出
            }, function (err) {
                if (err) {
                    console.error(err);
                    alert("カメラの起動に失敗しました。HTTPS環境であることを確認してください。");
                    return;
                }
                Quagga.start();
            });

            // 読み取り成功時のイベント
            Quagga.onDetected((data) => {
                if (data.codeResult && data.codeResult.code) {
                    const code = data.codeResult.code;
                    codeValue.innerText = code;

                    // 成功時にiPhone/Androidでバイブレーション
                    if (navigator.vibrate) navigator.vibrate(100);

                    // 連続読み取りを防ぐため、一度止める場合は Quagga.stop()
                    console.log("Detected: " + code);
                }
            });
        }
    </script>
</body>
</html>